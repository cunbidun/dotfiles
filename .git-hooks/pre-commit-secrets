#!/usr/bin/env bash
# Pre-commit hook to prevent committing credentials and secrets

set -euo pipefail

# Patterns to detect secrets
PATTERNS=(
  "PRIVATE.?KEY"
  "private.?key"
  "-----BEGIN.*PRIVATE.*-----"
  "-----BEGIN.*RSA.*-----"
  "-----BEGIN.*EC.*-----"
  "-----BEGIN.*OPENSSH.*-----"
  "AGE-SECRET-KEY"
  "SOPS_AGE_KEY"
  "API.?KEY"
  "SECRET.?KEY"
  "PASSWORD"
  "TOKEN"
  "AWS_SECRET"
  "GITHUB_TOKEN"
)

# Safe files (encrypted/config)
SAFE_PATTERNS=(
)

check_file() {
  local file="$1"
  
  # Skip binary files
  case "$file" in
    *.png|*.jpg|*.jpeg|*.gif|*.zip|*.tar|*.gz|*.bin) return 0 ;;
  esac
  
  # Check if file is in safe list
  for pattern in "${SAFE_PATTERNS[@]}"; do
    if [[ "$file" =~ $pattern ]]; then
      return 0
    fi
  done
  
  # Check for secret patterns
  for pattern in "${PATTERNS[@]}"; do
    if grep -iE "$pattern" "$file" 2>/dev/null > /dev/null; then
      return 1
    fi
  done
  
  return 0
}

main() {
  local exit_code=0
  local found_secrets=0
  
  while IFS= read -r file; do
    if [ -z "$file" ]; then
      continue
    fi
    if ! check_file "$file"; then
      echo "❌ BLOCKED: Potential secret in $file"
      exit_code=1
      found_secrets=1
    fi
  done < <(git diff --cached --name-only --diff-filter=ACM 2>/dev/null)
  
  if [ $found_secrets -eq 0 ]; then
    echo "✓ No secrets detected"
  else
    echo "ERROR: Secrets detected! To bypass: SKIP_PRECOMMIT=1 git commit"
    return 1
  fi
  
  return 0
}

main "$@"
