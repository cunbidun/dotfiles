#!/bin/bash

weatherreport=$HOME/.cache/weatherreport

showweather() {
	temp="$(awk 'NR==4' $weatherreport | awk '{ print $(NF-1) }' | sed 's/\x1b\[[0-9;]*m//g')"
	desc="$(awk 'NR==3' $weatherreport | awk '{ print $(NF-1) }' | xargs | sed 's/\x1b\[[0-9;]*m//g')"
	echo "$desc $tempÂ°C"
}

case $BLOCK_BUTTON in
1) setsid -f "$TERMINAL" -e less -Srf "$weatherreport" ;;
2) sc_weather_sync && showweather ;;
6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# The test if our forcecast is updated to the day. If it isn't download a new
# weather report from wttr.in with the above function.
[ "$(stat -c %y "$weatherreport" 2>/dev/null | cut -d' ' -f1)" = "$(date '+%Y-%m-%d')" ] ||
	sc_weather_sync

# check if the report is within 30 minutes
[ $((($(date +%s) - $(stat -L --format %Y .cache/weatherreport)) > (30 * 60))) ] ||
	sc_weather_sync

showweather
